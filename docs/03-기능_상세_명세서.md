# 기능 상세 명세서 (Functional Specification)

**프로젝트:** VHDL 파싱 및 시각적 디버깅  
**목적:** 각 모듈이 "어떻게 동작하고 어떤 데이터를 주고받는지"를 명세.  
**보완:** AST 기반 4단계 파싱 전략 및 Tree-sitter 엔진 반영.

---

## VHDL 세부 문법 파싱 단계 (4단계 Phased Approach)

구조적 깊이(Depth)와 논리적 흐름에 따라 파싱을 4단계로 나눈다.

| 단계 | 수준 | 파싱 대상 | 세분화 포인트 |
|------|------|-----------|----------------|
| **1단계** | Black-box | `library`, `use`, `entity`, `port`, `generic` | Port의 in/out, 데이터 타입(`std_logic`, `std_logic_vector`, `unsigned`), 버스 폭 `(7 downto 0)`, 초기값까지 토큰화 |
| **2단계** | Declaration | architecture 선언부: `signal`, `constant`, `variable`, 사용자 정의 `type` | `type ... is array`, `type ... is record`, enum/상태 타입(FSM)을 개별 노드로 분리 |
| **3단계** | Concurrent & Structural | `component` 인스턴스(`port map`, `generic map`), 병행 할당(`<=`), `when...else`, `with...select`, `for/if generate` | generate로 생성되는 반복 블록을 렌더러가 그릴 수 있도록 구조화 |
| **4단계** | Sequential & Behavioral | `process` 블록, 감지 목록(Sensitivity list), `if/elsif/else`, `case/when`, `for/while` | 특정 조건(예: `rising_edge(clk)`)에서의 동작, FSM 상태 전이도용 데이터 추출 |

검증 전략: **AST 전체 JSON 덤프**로 누락 구문 확인, **문법별 마이크로 테스트 파일**(`test_*.vhd`)로 단일 문법별 자동 검증.

---

## 3.1. 전처리기 (`core/preprocessor.py`)

| 항목 | 내용 |
|------|------|
| **동작** | 파싱 정확도를 높이기 위해 불필요한 문자열을 제거한다. |
| **Input** | 원본 VHDL 텍스트 문자열 |
| **Process** | • `--` 로 시작하는 단일 행 주석 제거<br>• 연속된 공백, 탭, 줄바꿈 문자를 단일 공백으로 정규화 (선택적) |
| **Output** | 정제된 VHDL 텍스트 문자열 |

---

## 3.2. 핵심 파서 엔진 (`core/ast_parser.py` — 기존 파서 통합·대체)

| 항목 | 내용 |
|------|------|
| **동작** | Tree-sitter 엔진을 이용해 VHDL 원문을 구문 분석하고, 4단계(인터페이스, 선언부, 구조적, 동작적) 깊이에 따라 데이터를 세분화하여 추출한다. |
| **Input** | 원본 VHDL 텍스트 (또는 파일 경로) |
| **Process** | 1. Tree-sitter VHDL grammar로 전체 텍스트를 **AST(추상 구문 트리)** 객체로 변환.<br>2. 트리 순회(Tree-walking)로 `entity_declaration`, `architecture_body` 노드 탐색.<br>3. `port_clause` 노드에서 타입·폭·방향을 토큰별로 쪼개어 추출.<br>4. `component_instantiation_statement` 노드에서 `port map` 매핑 관계 추출.<br>5. (2~4단계) 선언부·generate·process 등 나머지 노드 동일 방식으로 세분화. |
| **Output (Data Model)** | `models/vhdl_types.py`에 정의된 세분화된 객체 (Port, Signal, Component, ProcessBlock, TypeDef 등)의 리스트 및/또는 전체 AST 트리(JSON 덤프용). |

*기존 정규표현식 기반 `entity_parser`/`arch_parser`는 1단계 호환 또는 점진적 대체용으로 유지 가능.*

---

## 3.3. Entity 파서 (`core/entity_parser.py` — 1단계/레거시)

| 항목 | 내용 |
|------|------|
| **동작** | 정제된 텍스트에서 정규표현식(Regex) 또는 상태 머신을 이용해 외부 인터페이스를 추출한다. (AST 도입 후에는 AST 트리 탐색으로 대체 가능) |
| **Input** | 정제된 VHDL 텍스트 |
| **Process** | • `entity [이름] is` 구문에서 모듈 이름 추출<br>• `port (...)` 블록 내의 각 줄을 분석하여 딕셔너리 형태로 저장 |
| **Output (Data Model)** | Entity + Port 목록 (name, direction, type, width) |

**출력 예시 (JSON 형태):**

```json
{
  "module_name": "AND_GATE",
  "ports": [
    {"name": "A", "direction": "in", "type": "std_logic", "width": 1},
    {"name": "B", "direction": "in", "type": "std_logic", "width": 1},
    {"name": "Y", "direction": "out", "type": "std_logic", "width": 1}
  ]
}
```

---

## 3.4. Architecture 파서 (`core/arch_parser.py`)

| 항목 | 내용 |
|------|------|
| **동작** | `architecture` 블록 내부의 Signal, Component, Port Map 등을 추출한다. (AST 도입 시 `ast_parser`의 2~3단계에서 통합 처리) |
| **Input** | 정제된 VHDL 텍스트 (및 필요 시 Entity 파서 결과) |
| **Process** | • `architecture ... of ... is` 구간 식별<br>• `signal` 선언 목록 추출<br>• `component` 선언 및 인스턴스(`port map`) 추출 |
| **Output** | Signal 목록, Component 인스턴스 목록, Port Map 연결 정보 (데이터 모델) |

*(상세 필드 명세는 `models/vhdl_types.py` 및 `models/graph_model.py`와 연동하여 정의.)*

---

## 3.5. JSON Exporter (`exporters/json_exporter.py`)

| 항목 | 내용 |
|------|------|
| **동작** | 파이썬 메모리의 데이터 모델을 **웹 프론트엔드 및 VS Code Webview**가 렌더링하기 좋은 형태의 JSON으로 변환한다. |
| **Input** | `vhdl_types.py` / `graph_model.py`에 정의된 파이썬 객체 (또는 전체 AST 트리) |
| **Process** | `json.dumps()`를 활용하여 들여쓰기(`indent=4`)가 적용된 가독성 높은 문자열로 변환. **AST Full Dump** 옵션 시 파서가 인식한 모든 노드를 계층적 JSON으로 출력. |
| **Output** | `output.json` 파일 생성 (또는 호출자 지정 경로). 옵션: `output_ast_tree.json` 전체 트리 덤프. |

---

## 3.6. 디버깅용 Graphviz Exporter (`exporters/dot_exporter.py`)

| 항목 | 내용 |
|------|------|
| **동작** | 추출된 포트와 연결 정보를 바탕으로 노드와 엣지를 생성하여 시각적 흐름도를 만든다. |
| **Input** | 파이썬 데이터 모델 (Entity, Port, Signal, Component, Port Map 등) |
| **Process** | • `graphviz` 파이썬 라이브러리 호출<br>• `in` 포트는 왼쪽 노드로, `out` 포트는 오른쪽 노드로 배치 |
| **Output** | `debug_graph.png` 이미지 파일 저장 (또는 `.dot` / `.svg` 등 옵션 지원) |

---

## 모듈 간 데이터 흐름 요약

```
[원본 VHDL 문자열]
    → preprocessor → [정제 문자열]
    → ast_parser (Tree-sitter 엔진)
        ├─ 1/2단계 추출 → [Entity, Ports, Generics, Signals, Types, Constants]
        └─ 3/4단계 추출 → [Components, Port Maps, Generate, Process Blocks]
    → models (vhdl_types, graph_model)
    → json_exporter → output.json / output_ast_tree.json
    → dot_exporter  → debug_graph.png / .svg
```

*(1단계 호환: `entity_parser` → `arch_parser` 파이프라인은 AST 도입 전까지 유지.)*

이 명세는 향후 **웹 테스터 및 VS Code 확장 프로그램**과 연동할 때 **입력/출력 계약(API 스펙)**으로 활용할 수 있습니다.
